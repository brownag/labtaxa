# Automated GitHub Release creation after successful Docker build
# Publishes metadata and checksums as release assets
# Enables scientists to cite specific data snapshots

name: Create Release

on:
  workflow_run:
    workflows: ["Publish Docker image"]
    types:
      - completed

jobs:
  create-release:
    name: Create GitHub Release
    if: github.event.workflow_run.conclusion == 'success' && github.repository_owner == 'brownag'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate release tag and version
        id: version
        run: |
          # Create YYYY.MM format tag matching Docker tag scheme
          RELEASE_TAG=$(date -u +'%Y.%m')
          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

          # Also capture day for reference
          RELEASE_DATE=$(date -u +'%Y-%m-%d')
          echo "date=${RELEASE_DATE}" >> $GITHUB_OUTPUT

      - name: Pull Docker image
        id: docker_pull
        run: |
          docker pull ghcr.io/${{ github.repository }}:latest 2>/dev/null || docker pull brownag/labtaxa:latest
          echo "image_pulled=true" >> $GITHUB_OUTPUT

      - name: Extract metadata and cached data from built image
        id: metadata
        continue-on-error: true
        run: |
          # Create output directory
          mkdir -p /tmp/labtaxa-artifacts

          echo "Attempting to extract files from Docker image..."

          # Extract .labtaxa-metadata.json from the built Docker image
          docker run --rm ghcr.io/${{ github.repository }}:latest cat /home/rstudio/.labtaxa-metadata.json > /tmp/labtaxa-artifacts/build-metadata.json 2>/dev/null || \
          docker run --rm brownag/labtaxa:latest cat /home/rstudio/.labtaxa-metadata.json > /tmp/labtaxa-artifacts/build-metadata.json 2>/dev/null || \
          echo '{"status":"could_not_extract_metadata"}' > /tmp/labtaxa-artifacts/build-metadata.json

          # Extract snapshot-metadata.json
          docker run --rm ghcr.io/${{ github.repository }}:latest cat /home/rstudio/.local/share/R/labtaxa/snapshot-metadata.json > /tmp/labtaxa-artifacts/snapshot-metadata.json 2>/dev/null || \
          docker run --rm brownag/labtaxa:latest cat /home/rstudio/.local/share/R/labtaxa/snapshot-metadata.json > /tmp/labtaxa-artifacts/snapshot-metadata.json 2>/dev/null || \
          echo '{"status":"no_snapshot_metadata"}' > /tmp/labtaxa-artifacts/snapshot-metadata.json

          # Extract LDM RDS file
          echo "Extracting cached-LDM-SPC.rds..."
          if docker run --rm ghcr.io/${{ github.repository }}:latest cat /home/rstudio/.local/share/R/labtaxa/cached-LDM-SPC.rds > /tmp/labtaxa-artifacts/cached-LDM-SPC.rds 2>/dev/null; then
            echo "[OK] Extracted from ghcr.io"
          elif docker run --rm brownag/labtaxa:latest cat /home/rstudio/.local/share/R/labtaxa/cached-LDM-SPC.rds > /tmp/labtaxa-artifacts/cached-LDM-SPC.rds 2>/dev/null; then
            echo "[OK] Extracted from Docker Hub"
          else
            echo "[FAILED] Could not extract cached-LDM-SPC.rds"
          fi

          # Extract morphologic RDS file
          echo "Extracting cached-morph-SPC.rds..."
          if docker run --rm ghcr.io/${{ github.repository }}:latest cat /home/rstudio/.local/share/R/labtaxa/cached-morph-SPC.rds > /tmp/labtaxa-artifacts/cached-morph-SPC.rds 2>/dev/null; then
            echo "[OK] Extracted from ghcr.io"
          elif docker run --rm brownag/labtaxa:latest cat /home/rstudio/.local/share/R/labtaxa/cached-morph-SPC.rds > /tmp/labtaxa-artifacts/cached-morph-SPC.rds 2>/dev/null; then
            echo "[OK] Extracted from Docker Hub"
          else
            echo "[FAILED] Could not extract cached-morph-SPC.rds"
          fi

          echo ""
          echo "Extracted artifacts:"
          ls -lh /tmp/labtaxa-artifacts/ || echo "No artifacts found"

          echo "metadata_extracted=true" >> $GITHUB_OUTPUT

      - name: Create release notes
        id: notes
        run: |
          cat > /tmp/release-notes.md << 'EOF'
          ## KSSL Lab Data Mart Snapshot – ${{ steps.version.outputs.tag }}

          Monthly snapshot of USDA NRCS KSSL database with Lab Data Mart and NASIS morphologic data.

          ### Contents

          - `cached-LDM-SPC.rds` – Lab Data Mart profiles as SoilProfileCollection
          - `cached-morph-SPC.rds` – NASIS morphologic data as SoilProfileCollection
          - `snapshot-metadata.json` – Data checksums and build info
          - `build-metadata.json` – R version and dependencies

          ### Run

          ```bash
          docker pull ghcr.io/brownag/labtaxa:${{ steps.version.outputs.tag }}
          docker run -p 8787:8787 ghcr.io/brownag/labtaxa:${{ steps.version.outputs.tag }}
          ```

          Access RStudio at http://localhost:8787 (rstudio / soilscience)

          ### Load Data in R

          ```r
          library(labtaxa)
          ldm <- load_labtaxa()
          morph <- load_labmorph()
          ```

          ### Info

          - **Snapshot Date**: ${{ steps.version.outputs.date }}
          - **Source**: [USDA NRCS NCSS Lab Data Mart](https://ncsslabdatamart.sc.egov.usda.gov/)
          - **Docs**: https://brownag.github.io/labtaxa
          EOF

          # Output for use in release creation
          echo "notes_file=/tmp/release-notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.tag }}
          name: "KSSL Data Snapshot ${{ steps.version.outputs.tag }}"
          bodyFile: /tmp/release-notes.md
          artifacts: "/tmp/labtaxa-artifacts/cached-LDM-SPC.rds,/tmp/labtaxa-artifacts/cached-morph-SPC.rds,/tmp/labtaxa-artifacts/snapshot-metadata.json,/tmp/labtaxa-artifacts/build-metadata.json"
          artifactErrorsFailBuild: false
          allowUpdates: true
          makeLatest: true
          updateOnlyUnreleased: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "Release: ${{ steps.version.outputs.tag }} (https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})"
          echo "Artifacts:"
          ls -lh /tmp/labtaxa-artifacts/ | tail -n +2 | awk '{print "  " $9 " (" $5 ")"}'
